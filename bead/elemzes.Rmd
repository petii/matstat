---
title: "Statisztikai Elemzés"
author: "Vida Péter"
date: "16 May 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Adatok
A adathalmaz [erről a linkről származik](https://www.kaggle.com/abcsds/pokemon) (https://www.kaggle.com/abcsds/pokemon).

Az adataink a `data/Pokemon.csv` fájl tartalmazza. Soronként egy-egy pokémonról a következőket tudjuk:

* Name: a neve
* Type.1: az elsődleges típusa
* Type.2: a másodlagos típusa (lehet üres is)
* Total: az alábbi [tulajdonágok](https://bulbapedia.bulbagarden.net/wiki/Statistic) összege:
  + HP: életerő pontok
  + Attack: támadóérték
  + Defense: védelmi érték
  + Sp..Atk: speciális támadás
  + Sp..Def: speciális védekezés
  + Speed: sebesség
* Generation: melyik generációból való.
* Legendary: legendás pokémon-e

```{r}
data <- read.csv('data/Pokemon.csv')
labels(data)[2]
```

Az adatok közül nem vettem figyelembe a pokémonok [mega evolúcióját](https://bulbapedia.bulbagarden.net/wiki/Mega_Evolution), mivel ez egy ideiglenes állapot. Ez `r length(data[grepl("Mega",data$Name,fixed=TRUE),])` sor törlését jelentette.
Hasonló elgondolásból a pokémonok [primal formája](https://bulbapedia.bulbagarden.net/wiki/Primal_Reversion) is kikerült az adathalmazból.
Illetve a [Hoopa](https://bulbapedia.bulbagarden.net/wiki/Hoopa_(Pok%C3%A9mon)) "Unbound" alakja is.

```{r}
data <- data[!grepl("Mega",data$Name,fixed=TRUE),]
data <- data[!grepl("Primal",data$Name,fixed=TRUE),]
data <- data[!grepl("Unbound",data$Name,fixed=TRUE),]
```

Az adatokban a pokémonok, melyeknek különböző formái vannak, külön pokémonoknak számítanak. A duplikátumok elkerülése végett, ezeket a formákat kiszűrtem, a tulajdonságaikat pedig átlagoltam. Ilyen pokémonok voltak:

```{r}
for (x in levels(factor(data$X.))) {
  rows <- data[data$X. == x,]
  if (nrow(rows) > 1) {
    data <- data[data$X. != x,]
    name <- rows$Name[1]
    name <- strsplit(gsub("(.)([[:upper:]])", "\\1 \\2", name),' ')[[1]][[1]]
    print(name)
    levels(data$Name) <- c(levels(data$Name),name)
    statlab <- c('Total','HP','Attack','Defense','Sp..Atk','Sp..Def','Speed')
    base <- rows[1,]
    base$Name <- name
    for (l in statlab) {
      base[[l]] <- mean(rows[[l]])
    }
    data[nrow(data)+1,] <- base
  }
}
```

A [legendás pokémonok](https://bulbapedia.bulbagarden.net/wiki/Legendary_Pokémon) nagytöbbségében jobb tulajdonságokkal rendelkeznek, így az adathalmazunkat érdemes szétválasztani.

```{r}
legendsplit <- split(data,data$Legendary)
normal <- legendsplit$False
legendary <- legendsplit$True
```

Így a normális és a legendás pokémonok számának megoszlása: `r length(normal$Name)` és `r length(legendary$Name)`.

# Normális és legendás pokémonok közti különbségek

## Tulajdonságok

```{r}
layout(matrix(c(1,1,1,2,4,6,3,5,7),3,3))
labels <- c('Normal','Legendary')
labels.short <- c('L','N')
boxplot(normal$Total,legendary$Total,main="Total",names = labels)
boxplot(legendary$HP,normal$HP,main="HP",names = labels.short,horizontal = TRUE)
boxplot(legendary$Attack,normal$Attack,main="Attack",names = labels.short,horizontal = TRUE)
boxplot(legendary$Defense,normal$Defense,main="Defense",names = labels.short,horizontal = TRUE)
boxplot(legendary$Speed,normal$Speed,main="Speed",names = labels.short,horizontal = TRUE)
boxplot(legendary$Sp..Atk,normal$Sp..Atk,main="Special Attack",names = labels.short,horizontal = TRUE)
boxplot(legendary$Sp..Def,normal$Sp..Def,main="Special Defense",names = labels.short,horizontal = TRUE)
```

Ez alapján azt láthatjuk, hogy többségében a legendás pokémonok jobb tulajdonsagokkal rendelkeznek a normálisakkal szemben.

### Eloszlások

Tudjuk, hogy a legendás pokémonok tulajdonságai alapvetően magasabb értékűek a normális pokémonokénál. De vajon van-e hasonlóság abban, hogy az adott intervallumaikukon hogyan oszlanak el?

Ehhez a különböző tulajdonságok átlagát transzformáljuk valamely közös pontba, mondjuk legyen a $0$. Majd kétmintás Kolmogorov-Szmirnov próbával teszteljük az eloszlások hasonlóságát, $95\%$-os szignifikancia szint mellett.

```{r}
tests.ks <- list()

stats.names <- c('HP','Attack','Defense','Speed','Sp..Atk','Sp..Def')

for (i in stats.names) {
  layout(matrix(c(1:2),1,2,byrow = TRUE))
  tmp.norm <- normal[[i]] - mean(normal[[i]])
  tmp.legend <- legendary[[i]] - mean(legendary[[i]])
  dens.norm <- density(tmp.norm)
  dens.leg <- density(tmp.legend)
  limits.x <- c(min(min(tmp.norm),min(tmp.legend)),max(max(tmp.norm),max(tmp.legend)))
  limits.y <- c(0,max(max(dens.norm$y),max(dens.leg$y)))
  #layout(matrix(c(1,2),1,2,byrow = FALSE))
  #hist(tmp.norm,freq = FALSE,xlim = limits.x, ylim = limits.y,main = i,xlab = '')
  plot(dens.norm,xlim = limits.x, ylim = limits.y,main = i,xlab = '')
  #hist(tmp.legend,freq = FALSE,xlim = limits.x, ylim = limits.y,add=T,border = 2)
  lines(dens.leg,col = 2)
  plot(ecdf(tmp.norm),main='Tapasztalati eloszlásfüggvények')
  plot(ecdf(tmp.legend),add=TRUE,col=2)
  
  tests.ks[[i]] <- ks.test(tmp.norm,tmp.legend)
}

ks.value <- function(alpha,n,m) {
  sqrt(-1/2*log(alpha/2)) * sqrt((n+m)/(n*m))
}

#tests.f
alpha = 0.05
c <- ks.value(alpha,length(normal$Name),length(legendary$Name))
```

$95\%$-os szignifikancia szint mellett a kritikus tartomány: $|D| > `r c`$.

* Életerő
  + A próba statisztika értéke $`r tests.ks$HP$statistic` \le `r c`$, tehát nem vetettük el a nullhipotézist.
* Támadás  
  + A próba statisztika értéke $`r tests.ks$Attack$statistic` \le `r c`$, tehát nem vetettük el a nullhipotézist.
* Védekezés
  + A próba statisztika értéke $`r tests.ks$Defense$statistic` \le `r c`$, tehát nem vetettük el a nullhipotézist.
* Sebesség
  + A próba statisztika értéke $`r tests.ks$Speed$statistic` > `r c`$, tehát elvetettük a nullhipotézist.
* Speciális Támadás
  + A próba statisztika értéke $`r tests.ks$Sp..Atk$statistic` \le `r c`$, tehát nem vetettük el a nullhipotézist.
* Speciális Védekezés
  + A próba statisztika értéke $`r tests.ks$Sp..Def$statistic` \le `r c`$, tehát nem vetettük el a nullhipotézist.

## Típusok

A pokémonoknak legalább egy és maximum két típusa lehet. A típusnak a támadásoknál van szerepe, a különféle képességek más más típusra máshogy hathatnak. ("It's super effective!")
Mivel a két típussal rendelkező pokémonok mindkét típusuknak megfelelően erősebbek és gyengébbek a más típusokkal szemben, a típus szerinti összegzésbe mindkét típus szerint beleszámoltam őket. Az adatok összessége így több mint az eredeti, de talán átfogóbb képet kaphatunk.

### Másodlagos típus

Először az elsődleges és másodlagos típusok megoszlásást külön a normális és a legendás pokémonok között vizsgáltam.

```{r}
norm.type1.summary <- summary(normal$Type.1)
norm.type2.summary <- summary(normal$Type.2)[-1]
norm.types.summary <- t(cbind(as.matrix(norm.type1.summary),as.matrix(norm.type2.summary)))
norm.types.summary.normaled <- norm.types.summary/sum(norm.types.summary)
norm.types.summary.normaled.ordered <- norm.types.summary.normaled[,order(colSums(norm.types.summary.normaled),decreasing = TRUE)]
leg.type1.summary <- summary(legendary$Type.1)
leg.type2.summary <- summary(legendary$Type.2)[-1]
leg.types.summary <- t(cbind(as.matrix(leg.type1.summary),as.matrix(leg.type2.summary)))
leg.types.summary.normaled <- leg.types.summary/sum(leg.types.summary)
leg.types.summary.normaled.ordered <- leg.types.summary.normaled[,order(colSums(leg.types.summary.normaled),decreasing = TRUE)]
types.summary <- cbind(colSums(norm.types.summary),colSums(leg.types.summary))
types.summary.normaled <- cbind(types.summary[,1]/sum(types.summary[,1]),types.summary[,2]/sum(types.summary[,2]))

maxval <- max(max(colSums(norm.types.summary.normaled)),max(colSums(leg.types.summary.normaled)))
maxval <- c(0,maxval)

label.x <- 'Density'
legendtext.1 <- c('Type.1','Type.2')

layout(matrix(c(1,2),1,2,byrow = TRUE))
barplot(norm.types.summary.normaled.ordered,las=1,horiz = TRUE,legend.text = legendtext.1,main = 'Types in normal pokemons',xlab = label.x)
barplot(leg.types.summary.normaled.ordered,las=1,horiz = TRUE,xlim = maxval,legend.text = legendtext.1,main = 'Types in legendary pokemons',xlab = label.x)
```

```{r} 
num.water <- sum(norm.types.summary[,colnames(norm.types.summary)=='Water'])
num.normal <- sum(norm.types.summary[,colnames(norm.types.summary)=='Normal'])
num.sum <- sum(norm.types.summary)
```

* A repülő típus főleg másodlagosként szerepel
* Normális pokémonoknál a legyakoribb típus a víz, de ez `r num.water` darabot jelent, míg a második leggyakoribb, a "Normal" `r num.normal` darab (az `r num.sum`-ből), ez pedig nem tekinthető szignifikáns különbségnek (`r abs(num.water-num.normal)/num.sum*100`%).
* Legendás pokémonoknál jellemzőbbnek tűnik a második típus megléte. 
  + A legendás pokémonoknak `r sum(leg.type2.summary)/length(legendary$Type.2)*100`%-a,
  + Ezzel szemben a normálisoknak `r sum(norm.type2.summary)/length(normal$Type.2)*100`%-a
  rendelkezik másodlagos típussal

```{r}
layout(matrix(1,1,1))
barplot(t(types.summary.normaled),beside = TRUE,las = 2,legend.text = labels)
```

Észrevehető, hogy legendás pokémonok gyakrabban sárkány, repülő illetve psychic típusúak.

# Generáció szerinti bontás
 
```{r}
data.gens <- split(data,data$Generation)
normal.gens <- split(normal,normal$Generation)
legendary.gens <- split(legendary,legendary$Generation)
```

## Pokémonok száma

Megvizsgáltam, hogy a generációkban hogyan oszlik meg az új pokémonok száma, és erre lineáris modell illesztésével előrejelezni, hogy a következő 

```{r}
poke.num <- rep(0,6)
poke.num.cum <- rep(0,6)
gen.list <- c(1:length(data.gens))
for (i in gen.list) {
  poke.num[i] <- length(data.gens[[i]]$Name)
  poke.num.cum[i] <- sum(poke.num[1:i])
}

regr <- function(coefs,x) coefs[1] + x * coefs[2]

plot(poke.num)
num.model <- lm(poke.num~gen.list)
lines(num.model$fitted.values)
#lines(regr(num.model$coefficients,c(1:6)))

plot(poke.num.cum)
num.cum.model <- lm(poke.num.cum~gen.list)
lines(num.cum.model$fitted.values)

#regr <- function(coefs,x) sum(c(1,x)*coefs) 
gen7.num <- regr(num.model$coefficients,7)
gen7.num.cum <- regr(num.cum.model$coefficients,7)
```

A modell alapján a 7. generációban `r gen7.num` új pokémon lesz, azaz összesen `r sum(c(poke.num,gen7.num))`. A kumulált modell szerint a 7. generációban összesen `r gen7.num.cum` darab $(\Delta = `r abs(sum(c(poke.num,gen7.num)) - gen7.num.cum)`)$.
A [valódi 7. generációban](https://bulbapedia.bulbagarden.net/wiki/Generation) ezzel szemben 86 új pokémon volt, így lett összesen 807.

Tehát ha nem a kumulált pokémon számot néztük, pontosabb becslést kapunk.

Ha a modellünket kiegészítjük a 7. generáció pokémonjainak számával a 8. generációra az alábbi becslést kapjuk.

```{r}
gen7.num.exact <- 86
gen.list.ext <- c(1:7)
poke.num.ext <- c(poke.num,gen7.num.exact)
plot(poke.num.ext)
legend('topright', legend = c('Eredeti','Kiegészített'), col=c(2,1),lty = 1)
num.ext.model <- lm(poke.num.ext~gen.list.ext)
lines(num.ext.model$fitted.values)
lines(regr(num.model$coefficients,c(1:7)),col=2)

gen8.num <- c(0,0)
gen8.num[1] <- regr(num.model$coefficients,8)
gen8.num[2] <- regr(num.ext.model$coefficients,8)
#num.model$coefficients - num.ext.model$coefficients
```

Ez alapján a modell alapján a becslés a 8. generáció új pokémonjainak számára $`r gen8.num[2]`$, míg az előző modell alapján $`r gen8.num[1]`$ $(\Delta=`r abs(gen8.num[1]-gen8.num[2])`)$.

## Tulajdonságok

Generációkra lebontva a legendás pokémonok száma elenyésző, így őket nem vettem bele a vizsgálatba a továbbiakban.

```{r}
#gen1 <- list(both = data.gens$'1', normal = normal.gens$'1', legendary = legendary.gens$'1')
gen1 <- normal.gens$'1'
gen2 <- normal.gens$'2'
gen3 <- normal.gens$'3'
gen4 <- normal.gens$'4'
gen5 <- normal.gens$'5'
gen6 <- normal.gens$'6'
boxplot(gen1$Total,gen2$Total,gen3$Total,gen4$Total,gen5$Total,gen6$Total,main='Generációk össz tulajdonságai',names = names(data.gens),col = c(2:7))
layout(matrix(c(1:6),2,3,byrow = TRUE))
for (i in stats.names) {
  boxplot(gen1[[i]],gen2[[i]],gen3[[i]],gen4[[i]],gen5[[i]],gen6[[i]],main=i,names = names(data.gens),col = c(2:7))
}
```

Innen azt vehetjük észre, hogy a negyedik generációban összességében erősebb pokémonok érkeztek.

## Típusok

Itt arra voltam kíváncsi, hogy vannak-e különböző típus trendek a különböző generációkban.

```{r}
gens.types.summary <- NULL
gens.types.summary.normaled <- NULL

for (gen in normal.gens) {
  #print(i$Type.1)

gen.type1.summary <- summary(gen$Type.1)
gen.type2.summary <- summary(gen$Type.2)[-1]
gen.types.summary <- t(cbind(as.matrix(gen.type1.summary),as.matrix(gen.type2.summary)))
types.sum <- colSums(gen.types.summary)
types.summary.normaled <- colSums(gen.types.summary) / nrow(gen) 
gens.types.summary <- cbind(gens.types.summary,types.sum)
gens.types.summary.normaled <- cbind(gens.types.summary.normaled,types.summary.normaled)

#barplot(types.summary)
}
#gens.types.summary <- t(gens.types.summary)
gens.types.summary.normaled <- t(gens.types.summary.normaled)
#barplot(gens.types.summary,horiz = FALSE,las=2,beside = TRUE)
barplot(gens.types.summary.normaled,horiz = FALSE,las=2,beside = TRUE,col=c(2:7))
```


* Az első generációban a méreg és a víz típusú pokémonok a gyakoriak, de a méreg típus csak az első generációban volt ilyen meghatározó.
* A második generációban a repülő pokémonok száma kiugró.
* A hatodik generációban pedig a "Fairy" típus örvendett nagy népszerűségnek.

### Próba

Legyen a nullhipotézisünk, hogy a pokémon típusa nem függ attól hogy hanyadik generációs.

```{r}
alpha <- 0.05
gens.types.summary
res <- chisq.test(gens.types.summary)
crit <- qchisq(alpha,res$parameter)
res
```

A próbához tartozó kritikus tartományunk $`r alpha*100`\%$-os szignifikancia szint mellett : $\chi^2 > `r crit`$.
A próba eredménye $`r res$statistic` > `r crit`$, tehát a nullhipotézist elvetjük, és a pokémon típusa függ attól, hogy hanyadik generációs.

# A dokumentumról
Ez a dokumentum [R Studio](https://www.rstudio.com/)-ban készült, a forrása egy `.Rmd` (R Markdown) fájl (mellékelve). 
A dokumentumban szereplő kódrészletek a generálásakor kiértékelődtek, és azok kimenete látszik.
A csatolt `.r` fájlban a dokumentumban szereplő kódrészletek vannak összegyűjtve.
